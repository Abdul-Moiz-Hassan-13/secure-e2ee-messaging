<!DOCTYPE html>
<html>
<body>
<h2>Signed ECDH MITM Test</h2>
<button onclick="send()">Send Signed ECDH Request</button>

<script>
async function send() {
  // 1. CREATE IDENTITY KEY
  const identity = await crypto.subtle.generateKey(
    { name: "ECDSA", namedCurve: "P-256" },
    true,
    ["sign", "verify"]
  );

  const identityPub = await crypto.subtle.exportKey("spki", identity.publicKey);
  const identityPubB64 = btoa(String.fromCharCode(...new Uint8Array(identityPub)));

  // 2. CREATE EPHEMERAL ECDH KEY
  const eph = await crypto.subtle.generateKey(
    { name: "ECDH", namedCurve: "P-256" },
    true,
    ["deriveKey"]
  );

  const ephPub = await crypto.subtle.exportKey("raw", eph.publicKey);
  const ephPubB64 = btoa(String.fromCharCode(...new Uint8Array(ephPub)));

  // 3. SIGN THE EPHEMERAL KEY USING IDENTITY KEY
  const signatureBuf = await crypto.subtle.sign(
    { name: "ECDSA", hash: "SHA-256" },
    identity.privateKey,
    new TextEncoder().encode(ephPubB64)
  );

  const signatureB64 = btoa(String.fromCharCode(...new Uint8Array(signatureBuf)));

  // 4. SEND TO SERVER
  const res = await fetch("http://localhost:4000/api/mitm-demo/signed-ecdh", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      clientEphemeralPublicKey: ephPubB64,
      clientIdentityPublicKey: `-----BEGIN PUBLIC KEY-----\n${identityPubB64}\n-----END PUBLIC KEY-----`,
      signature: signatureB64
    })
  });

  const data = await res.text();
  document.body.innerHTML += "<pre>" + data + "</pre>";
}
</script>

</body>
</html>
